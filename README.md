<div align="center">

# LightningTrain

[![python](https://img.shields.io/badge/-Python_%7C_3.10-blue?logo=python&logoColor=white)](https://github.com/pre-commit/pre-commit)
[![pytorch](https://img.shields.io/badge/PyTorch_2.0+-ee4c2c?logo=pytorch&logoColor=white)](https://pytorch.org/get-started/locally/)
[![lightning](https://img.shields.io/badge/-Lightning_2.0+-792ee5?logo=pytorchlightning&logoColor=white)](https://pytorchlightning.ai/)
[![hydra](https://img.shields.io/badge/Config-Hydra_1.3-89b8cd)](https://hydra.cc/)

A clean and simple PyTorch Lightning + Hydra projects.

</div>

## üìå  Introduction

This repository contains a simple PyTorch Lightning + Hydra project template. It is designed to be a starting point for your own projects. It is based on the [PyTorch Lightning](https://lightning.ai/docs/pytorch/stable/).

<br>

## üì¶  Main Technologies

[PyTorch Lightning](https://github.com/PyTorchLightning/pytorch-lightning) - a lightweight PyTorch wrapper for high-performance AI research. Think of it as a framework for organizing your PyTorch code.

[Hydra](https://github.com/facebookresearch/hydra) - a framework for elegantly configuring complex applications. The key feature is the ability to dynamically create a hierarchical configuration by composition and override it through config files and the command line.

<br>

## üìÅ  Project Structure

The directory structure of new project looks like this:

```
lightningtrain
‚îú‚îÄ‚îÄ .dvc                 <- DVC files
‚îú‚îÄ‚îÄ data                 <- Data files
‚îú‚îÄ‚îÄ lightining                 
‚îÇ   ‚îú‚îÄ‚îÄ .devcontainer         <- dev container files
‚îÇ   ‚îú‚îÄ‚îÄ configs                 <- Configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ callbacks              <- Callback configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data                   <- Data configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ experiment             <- Experiment configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hydra                  <- Hydra configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger                 <- Logger configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model                  <- Model configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ paths                  <- Project paths
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trainer                <- Trainer configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py           <- Makes a Python module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infer.yaml             <- Main config for inference
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ eval.yaml           <- Main config for evaluation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ train.yaml          <- Main config for training
‚îÇ   ‚îú‚îÄ‚îÄ docker                 <- Docker files
‚îÇ   ‚îú‚îÄ‚îÄ lightningtrain                    <- Source code
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data                     <- Data scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models                   <- Model scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils                    <- Utility scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infer.py                 <- Run inference
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ train.py                 <- Run training
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ eval.py                  <- Run evaluation
‚îÇ   ‚îú‚îÄ‚îÄ scripts                <- Scripts
‚îÇ   ‚îú‚îÄ‚îÄ tests                  <- Tests of any kind
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore                <- List of files ignored by docker
‚îÇ   ‚îú‚îÄ‚îÄ Makefile                  <- Makefile with commands
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt          <- File for installing python dependencies
‚îÇ   ‚îî‚îÄ‚îÄ setup.py                  <- File for installing project as a package
‚îú‚îÄ‚îÄ logger
‚îÇ   ‚îú‚îÄ‚îÄ .devcontainer         <- dev container files
‚îÇ   ‚îú‚îÄ‚îÄ docker                 <- Docker files
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore                <- List of files ignored by docker
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt          <- File for installing python dependencies
‚îú‚îÄ‚îÄ demo                   <- Demo files
‚îÇ   ‚îú‚îÄ‚îÄ .devcontainer         <- dev container files
‚îÇ   ‚îú‚îÄ‚îÄ docker                 <- Docker files
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore                <- List of files ignored by docker
‚îÇ   ‚îú‚îÄ‚îÄ configs                 <- Configs
‚îÇ   ‚îú‚îÄ‚îÄ utils                   <- Utility python scripts
‚îÇ   ‚îú‚îÄ‚îÄ demo_gpt.py                 <- Run demo got GPT
‚îÇ   ‚îú‚îÄ‚îÄ demo_vit.py                 <- Run demo for ViT
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt          <- File for installing python dependencies
‚îú‚îÄ‚îÄ logs                   <- Logs generated by hydra and lightning loggers
‚îú‚îÄ‚îÄ notebooks              <- Jupyter notebooks
‚îú‚îÄ‚îÄ outputs                <- Output files generated by lightining hydra
‚îú‚îÄ‚îÄ .gitignore                <- List of files ignored by git
‚îú‚îÄ‚îÄ data.dvc                  <- DVC file for data
‚îú‚îÄ‚îÄ docker-compose.yaml       <- Docker compose file
‚îú‚îÄ‚îÄ LICENSE                   <- License
‚îú‚îÄ‚îÄ logs.dvc                  <- DVC file for logs
‚îú‚îÄ‚îÄ outputs.dvc               <- DVC file for outputs
‚îî‚îÄ‚îÄ README.md                 <- Readme
```

<br>

## üöÄ  Quickstart
```bash
# clone project
$ git clone https://github.com/sh-aidev/lightningtrain.git -b demo

# change directory to lightning
$ cd lightningtrain/lightning

# create docker container with .devcontainer.json
# or install dependencies locally

# install project as a package
$ pip install -e .

# run training
$ lightningtrain_train data.num_workers=8

# run demo for gpt
$ python3 lightningtrain/demo_gpt.py

# run demo for vit
$ python3 lightningtrain/demo_vit.py

```

## üîß  Docker container usage instructions
**Prerequisites:**
- [Docker](https://docs.docker.com/get-docker/)
- [Visual Studio Code](https://code.visualstudio.com/)
- [Remote - Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) extension

**Steps:**
1. Clone this repository
2. Open the repository in Visual Studio Code
3. Use docker-compose to build the container
following commands:
```bash
# To only run lightining container and train run:

$ docker-compose run lightning

# To run logger container to start logger ui after training is done run:

$ docker-compose run logger

# To run both containers together run:

$ docker-compose up

# To stop containers run:

$ docker-compose down

# To run demo:
$ docker-compose run demo

# To run demo docker saparately:
$ cd demo
$ docker build . -t lightningtrain_demo:latest -f docker/Dockerfile.dev
$ docker run -it --rm lightningtrain_demo:latest -v ./outputs:/workspace/outputs

```
<br>

## üó° Demo usage instructions
**Steps to see VIT demo:**
1. Once docker starts running open localhost:8080 in browser:
![gradio demo vit 1](images/demo/demo_1.png)
2. Click on upload and select a image to upload and we can see top 10 predictions as below:
![gradio demo vit 2](images/demo/demo_2.png)

**Steps to see GPT demo:**
1. Once docker starts running open localhost:8080 in browser:
![gradio demo gpt 1](images/demo/demo_3.png)
2. Write some text for completion and click on submit and we can see the completion as below:
![gradio demo gpt 2](images/demo/demo_4.png)

<br>

## üó° DVC usage instructions
**Prerequisites:**
- [DVC](https://dvc.org/doc/install)
- [DVC-gdrive](https://pypi.org/project/dvc-gdrive/)

**Steps:**
1. Clone this repository
2. Open the repository in Visual Studio Code
3. Run lightning training using above commands
4. Run following commands to push data, logs and outputs to gdrive:
```bash
# To initialize dvc run:
$ dvc init

# To add data run:
$ dvc add data

# In case you get error like ERROR:  output 'data' is already tracked by SCM (e.g. Git). You can remove it from Git, then add to DVC.
# Run following commands:
$ git rm -r --cached 'data'
$ git commit -m "stop tracking data"

# Then run the dvc add data again and do the same for the logs and outputs or any folder you want to track using dvc


# To add logs run:
$ dvc add logs

# To add outputs run:
$ dvc add outputs

# To add gdrive remote run:
$ dvc remote add --default gdrive gdrive://<you gdrive folder hash e.g. 1Vxjx2QERJnr58ECVHsyihJXkFBpFe1fj>
# You can get gdrive folder hash from browser folder link

# To add see dvc remote list run:
$ dvc remote list

# To push data to gdrive run:
$ dvc push -r gdrive

```


<br>

## üó°  Logger UI usage instructions

**AIM Logger:**
1. Open AIM UI in browser at http://localhost:43800
2. Click on runs tab to see all runs:
![AIM UI start](images/logs/aim_2.png)
3. Select latest runs and click on compare to see all runs plots:
![AIM UI compare](images/logs/aim_3.png)
4. Click on edit icon and add val ccc matric to compare in Matrics tab and click on search:
![AIM UI compare](images/logs/aim_4.png)
5. Search for the hyperparameter you want to compare in the below section and select group by color and you can see the comparison for the experiment(In our case patch_size):
![AIM UI compare](images/logs/aim_1.png)

**MLFlow Logger:**
1. Open MLFlow UI in browser at http://localhost:5000
2. Click on experiments name to see all runs for that experiment:
![MLFlow UI start](images/logs/mlflow_2.png)
3. Click on runs you want to comapre and click on compare to see all runs plots:
![MLFlow UI compare](images/logs/mlflow_3.png)
4. From left side Parameters section select the hyperparameter you want to compare e.g. patch_size and from Matrics section select the matric you want to compare e.g. val/acc and epoch then you can see the plots for the experiment(In our case patch_size):
![MLFlow UI compare](images/logs/mlflow_1.png)
<br>


## üß∞ References
- [PyTorch Lightning](https://lightning.ai/docs/pytorch/stable/)
- [Hydra](https://hydra.cc/docs/intro/)
- [Lightning-Hydra-Template](https://github.com/ashleve/lightning-hydra-template.git)
- [Lightning Template](https://github.com/satyajitghana/lightning-template.git)
- [AIM](https://aimstack.readthedocs.io/en/latest/overview.html)
- [MLFlow](https://mlflow.org/docs/latest/tracking.html)

<br>